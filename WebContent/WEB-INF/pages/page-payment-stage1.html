<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="assets/img/favicon.ico" type="image/x-icon"> 
    
    <!-- Bootstrap CSS -->
    <link href="assets/css/bootstrap.css" rel="stylesheet">
    <link href="assets/css/bootstrap-icons.css" rel="stylesheet">
    <!-- User Define CSS -->
    <style>
        .container {
            max-width: 960px;
        }
        form#product-list-formcheck {
            font-size: 0.75em;
        }
    </style>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="assets/js/w3.js"></script>
    <script src="assets/js/jQuery-3.6.0.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <!-- User Define JS -->
    <script>
        $(document).ready(function () {
            // 遍歷清單，並且以Form型式加入畫面中
            jQuery.each(productsListJSON, function (idx, productEachObj) {
                // <div> root
                let aDiv = document.createElement("div");
                aDiv.setAttribute("class", "form-group row");
                // <div> - <div1> col-1 放圖片
                let b1Div = document.createElement("div");
                b1Div.setAttribute("class", "col-md-1");
                let imgB1 = document.createElement("img");
                imgB1.setAttribute("src", productEachObj.imgSrc);
                imgB1.setAttribute("class", "img-fluid");
                b1Div.appendChild(imgB1);
                // <div> - <div2> col-7 放商品名稱
                let b2Div = document.createElement("div");
                b2Div.setAttribute("class", "col-md-7");
                let labelB2 = document.createElement("label");
                let textB2 = document.createTextNode(productEachObj.name);
                labelB2.appendChild(textB2);
                b2Div.appendChild(labelB2);
                // <div> -<div3> col-1 放商品單價
                let b3Div = document.createElement("div");
                b3Div.setAttribute("class", "col-md-1");
                b3Div.innerHTML = productEachObj.price;
                // <div> - <div4> col-1 放商品個數
                let b4Div = document.createElement("div");
                b4Div.setAttribute("class", "col-md-1");
                let inputB4 = document.createElement("input");
                inputB4.setAttribute("class", "form-control form-control-sm");
                inputB4.setAttribute("type", "text");
                inputB4.setAttribute("value", productEachObj.quantity);
                b4Div.appendChild(inputB4);
                // <div> - <div5> col-1 放價格小計
                let b5Div = document.createElement("div");
                b5Div.setAttribute("class", "col-md-1");
                let boldB5 = document.createElement("b");
                boldB5.setAttribute("class", "text-danger");
                let textB5 = document.createTextNode(productEachObj.price * productEachObj.quantity);
                boldB5.appendChild(textB5);
                b5Div.appendChild(boldB5);
                // <div> - <div6> col-1 放商品刪除觸發事件
                let b6Div = document.createElement("div");
                b6Div.setAttribute("class", "col-md-1");
                let trashB6 = document.createElement("i");
                trashB6.setAttribute("class", "bi bi-trash btn btn-light");
                b6Div.appendChild(trashB6);

                aDiv.appendChild(b1Div);
                aDiv.appendChild(b2Div);
                aDiv.appendChild(b3Div);
                aDiv.appendChild(b4Div);
                aDiv.appendChild(b5Div);
                aDiv.appendChild(b6Div);
                $("hr").eq(0).before(aDiv);
            });
            // 改變數量時更改小計金額
            $("body").on("change", "input", function () {
                $(this).parent().next().find("b").eq(0).text(($(this).val() * $(this).parent().prev().text()));
                let changeQua = $(this).val();
                let changeName = $(this).parent().parent().find("div").eq(1).find("label").eq(0).text();
                // 跟新JSON裡面該物件的數量的值
                jQuery.each(productsListJSON, function (idx, product) {
                    if (product.name === changeName) {
                        product.quantity = changeQua;
                        // console.log(product);
                        return false;
                    }
                });
            })
            // 商品刪除觸發
            $("body").on("click", "form div i", function () {
                // 取出要刪除的名稱，其實不太好...重名就完了
                let removeName = $(this).parent().parent().find("div").eq(1).find("label").eq(0).text();
                // console.log("要移除的 removename : " + removeName);
                // JSON購物清單該項刪除
                jQuery.each(productsListJSON, function (idx, product) {
                    // console.log("第 " + idx + " 筆資料 : ");
                    // console.log(product.name);
                    if (product.name === removeName) {
                        productsListJSON.splice(idx, 1);
                        return false;
                    }
                });
                // 購物籃商品總數-1
                productCount--;
                // console.log("剩下的list" + productsListJSON);
                // 送出清單的按鈕移除
                $(this).parent().parent().remove();
                // 如果沒有商品了就顯示 : "商品明細沒有資料" 並且給予返回首頁的按鈕
                if (productCount === 0) {
                    $("form#product-list-formcheck").children("div").eq(0).after("商品明細沒有資料");
                    $("button:contains('下一步')").remove();
                    let returnA = document.createElement("a");
                    returnA.setAttribute("class", "btn btn-secondary btn-lg btn-block");
                    returnA.setAttribute("href", "index");
                    returnA.innerHTML = "前往首頁";
                    $("form#product-list-formcheck").append(returnA);
                    $("h3 span:first-of-type").attr("class", "text-danger");
                }
            })
            // 訂單進入下一步 : 確認付款方式與地址
            $("body").on("click", "button#button-next-step", function () {
                localStorage.myProducts = JSON.stringify(productsListJSON);
				// console.log(JSON.stringify(productsListJSON));
            });
        });
        // -------------------------------全域變數-------------------------------
        // 取得JSON購物清單
        var productsListJSON = JSON.parse(localStorage.myProducts);
        // console.log("payment收到的JSON : ")
        // console.log(productsListJSON);
        // 購物籃商品總數
        var productCount = productsListJSON.length;
        // console.log(productCount);
        // -------------------------------全域變數-------------------------------
    </script>
    
    <title>FurHouse</title>
    
</head>
<body class="bg-light">
	<div class="container">
	    <div class="py-5 text-center">
	        <h3><span class="text-success">確認購買商品與運送</span>
	            <i class="bi bi-arrow-right-circle"></i>
	            <span>確認付款方式與地址</span>
	            <i class="bi bi-arrow-right-circle"></i>
	            <span>完成訂購</span>
	        </h3>
	    </div>
	    <div class="row">
	        <h4 class="mb-3">商品明細</h4>
	        <div class="col-md-12">
	            <form class="needs-validation" id="product-list-formcheck" method="post" action="paymentS2"
	                  novalidate>
	                <div class="form-group row bg-secondary text-white">
	                    <div class="col-md-1">
	                        <label>商品</label>
	                    </div>
	                    <div class="col-md-7">
	                        <label>名稱與規格</label>
	                    </div>
	                    <div class="col-md-1">
	                        <label>單價</label>
	                    </div>
	                    <div class="col-md-1">
	                        <label>數量</label>
	                    </div>
	                    <div class="col-md-1">
	                        <label>小計</label>
	                    </div>
	                    <div class="col-md-1">
	                        <label>變更</label>
	                    </div>
	                </div>
	                <hr class="mb-4">
	                <button class="btn btn-primary btn-lg btn-block" id="button-next-step" type="submit">下一步</button>
	            </form>
	        </div>
	    </div>
	    <footer class="pt-5 text-muted text-center text-small">
	        <p class="mb-1">&copy; 2021-2021 CatBow 貓飽×貓寶</p>
	        <ul class="list-inline">
	            <li class="list-inline-item"><a href="#">Privacy</a></li>
	            <li class="list-inline-item"><a href="#">Terms</a></li>
	            <li class="list-inline-item"><a href="#">Support</a></li>
	        </ul>
	    </footer>
	</div>
</body>
</html>